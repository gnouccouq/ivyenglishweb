<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm tra tr√¨nh ƒë·ªô - ivyEnglish</title>
    <link rel="canonical" href="https://ivyenglish.io.vn/ivyenglish-level-test.html" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root { 
            --primary-color: #5b8cff; 
            --secondary-color: #2ECC71;
            --text-color: #1e293b; 
            --bg-body: #f4f7fa; 
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        body { 
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body) !important;
            color: var(--text-color);
            min-height: 100vh;
        }

        header { 
            position: fixed; top: 0; width: 100%; z-index: 1000; 
            background: rgba(51, 65, 85, 0.9); backdrop-filter: blur(10px); 
            height: 70px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-container { 
            max-width: 1100px; margin: 0 auto; display: flex; 
            justify-content: space-between; align-items: center; 
            height: 100%; padding: 0 20px; 
        }

        .main-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 100px 20px 40px;
            min-height: calc(100vh - 140px);
        }

        .test-container {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 850px;
            box-shadow: var(--shadow-soft);
        }

        #exam-screen, #result-screen { display: none; }

        .level-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
        }
        .level-table th, .level-table td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.3); }
        .level-table th { background: var(--primary-color); color: white; }

        .btn-action {
            background: var(--secondary-color);
            color: white;
            padding: 15px 45px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.2);
            transition: 0.3s;
        }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(46, 204, 113, 0.3); }

        .option {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--glass-border);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        .option:hover { background: white; transform: translateX(5px); }
        .option.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .progress-bar { height: 8px; background: rgba(0,0,0,0.05); border-radius: 10px; margin: 20px 0; }
        .progress { height: 100%; background: var(--primary-color); width: 0%; border-radius: 10px; transition: 0.3s; }
        .timer { font-weight: 900; color: #ef4444; font-size: 1.2rem; }
    </style>
</head>
<body>

    <header>
        <div class="nav-container">
            <a href="index.html"><img src="images/logo.png" alt="Logo" style="height: 40px;"></a>
            <div style="display: flex; gap: 20px;">
                <a href="index.html" style="color: white; text-decoration: none; font-weight: 500;">Home</a>
                <a href="index.html#courses" style="color: white; text-decoration: none; font-weight: 500;">Courses</a>
            </div>
        </div>
    </header>

    <div class="main-wrapper">
        <div id="intro-screen" class="test-container">
            <h2 style="text-align: center; color: var(--primary-color);">H∆Ø·ªöNG D·∫™N KI·ªÇM TRA</h2>
            <ul style="margin-bottom: 20px;">
                <li>B√†i test g·ªìm 15 c√¢u h·ªèi (Ng·ªØ ph√°p, T·ª´ v·ª±ng & ƒê·ªçc hi·ªÉu).</li>
                <li>C√¢u 15 l√† b√†i vi·∫øt ng·∫Øn (Writing).</li>
                <li>K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i ƒë·ªÉ gi√°o vi√™n t∆∞ v·∫•n l·ªô tr√¨nh.</li>
            </ul>

            <table class="level-table">
                <thead>
                    <tr><th>S·ªë c√¢u ƒë√∫ng</th><th>Tr√¨nh ƒë·ªô</th></tr>
                </thead>
                <tbody>
                    <tr><td>0 - 5 c√¢u</td><td><strong>A1 (Beginner)</strong></td></tr>
                    <tr><td>6 - 8 c√¢u</td><td><strong>A2 (Elementary)</strong></td></tr>
                    <tr><td>9 - 11 c√¢u</td><td><strong>B1 (Intermediate)</strong></td></tr>
                    <tr><td>12 - 15 c√¢u</td><td><strong>B2 (Upper-Intermediate)</strong></td></tr>
                </tbody>
            </table>

            <div style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; max-width: 320px; margin-left: auto; margin-right: auto;">
                <input type="text" id="userName" placeholder="H·ªç v√† T√™n (*)" required style="padding: 12px; border: 1px solid #ddd; border-radius: 20px;">
                <input type="tel" id="userPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i (Zalo)" required style="padding: 12px; border: 1px solid #ddd; border-radius: 20px;"
                required 
                            pattern="^0[0-9]{9}$" 
                            title="S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0 v√† c√≥ t·ªïng c·ªông 10 ch·ªØ s·ªë (VD: 0987654321)">
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-action" onclick="startExam()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
            </div>
        </div>

        <div id="exam-screen" class="test-container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="timer" id="timer">10:00</div>
                <div id="question-counter" style="font-weight: bold;">C√¢u h·ªèi 1/15</div>
            </div>
            <div class="progress-bar"><div class="progress" id="progress"></div></div>
            
            <div id="reading-passage" style="display: none; margin-bottom: 20px;"></div>
            
            <h3 id="question-text" style="margin-bottom: 20px; line-height: 1.5;"></h3>
            
            <div id="options-container"></div>

            <div style="margin-top: 30px; text-align: right;">
                <button id="next-btn" class="btn-action" style="padding: 10px 30px; font-size: 1rem;" onclick="nextQuestion()">Ti·∫øp theo</button>
            </div>
        </div>

        <div id="result-screen" class="test-container" style="text-align: center;">
            <h2 style="color: var(--secondary-color);">Ho√†n th√†nh!</h2>
            <div style="font-size: 4rem; font-weight: 900; margin: 10px 0;"><span id="score-number">0</span>/15</div>
            <h3 id="suggested-course" style="color: var(--primary-color);">--</h3>
            <p id="course-desc" style="margin-bottom: 30px; padding: 0 20px;">--</p>
            <div id="ai-feedback" style="font-style: italic; color: #475569; background: #f8fafc; padding: 15px; border-radius: 10px; margin: 0 20px 20px; border-left: 4px solid var(--primary-color); text-align: left; font-size: 0.95rem; line-height: 1.5;">
                ƒêang ƒë·ª£i AI ph√¢n t√≠ch b√†i l√†m...
            </div>
            <button class="btn-action" onclick="location.href='index.html'">V·ªÄ TRANG CH·ª¶</button>
        </div>
    </div>

<script>
    const questions = [
        { q: "1. Hello! How ___ you?", options: ["A. is", "B. are", "C. am", "D. be"], answer: 1 },
        { q: "2. She ___ in Spain.", options: ["A. live", "B. lives", "C. is live", "D. living"], answer: 1 },
        { q: "3. I don‚Äôt have ___ apples.", options: ["A. a", "B. some", "C. any", "D. much"], answer: 2 },
        { q: "4. What time do you usually ___ up?", options: ["A. get", "B. gets", "C. getting", "D. to get"], answer: 0 },
        { q: "5. Can I ___ you a question?", options: ["A. say", "B. tell", "C. speak", "D. ask"], answer: 3 },
        { q: "6. We ___ to the zoo last weekend.", options: ["A. go", "B. goes", "C. went", "D. gone"], answer: 2 },
        { q: "7. This music is too ___. Turn it down!", options: ["A. loudly", "B. loud", "C. loudest", "D. louder"], answer: 1 },
        { q: "8. I enjoy ___ detective stories.", options: ["A. to read", "B. reading", "C. read", "D. reads"], answer: 1 },
        { q: "9. If it rains, we ___ stay inside.", options: ["A. will", "B. would", "C. do", "D. did"], answer: 0 },
        { q: "10. Choose the correct sentence:", options: ["A. I can to swim.", "B. She don't like tea.", "C. They are play football.", "D. He goes to work by bus."], answer: 3 },
        { q: "11. What does she look like?", options: ["A. She likes reading books.", "B. She's very kind and helpful.", "C. She has short black hair.", "D. She looks at the window."], answer: 2 },
        { q: "12. Where does Lian work?", options: ["A. In a hospital", "B. In a travel agency", "C. In a zoo", "D. In a school"], answer: 1 },
        { q: "13. What does Lian like to do in her free time?", options: ["A. Cook and read", "B. Watch sports", "C. Watch wildlife shows and listen to music", "D. Go shopping"], answer: 2 },
        { q: "14. Why does Lian love her job?", options: ["A. She travels every day", "B. She meets animals", "C. She learns about new places", "D. She doesn't like it"], answer: 2 },
        { q: "15. Write 3 sentences about your favorite type of TV show, book, or music.", type: "writing" }
    ];

    let currentIdx = 0;
    let score = 0;
    let timeLeft = 600; 
    let timerInterval;
    let selectedIdx = null;
    let userWrongAnswers = []; // ƒê√É TH√äM: Khai b√°o m·∫£ng l∆∞u c√¢u sai

    function startExam() {
        const name = document.getElementById('userName').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        if (name === "" || phone === "") {
            alert("Vui l√≤ng nh·∫≠p H·ªç t√™n v√† S·ªë ƒëi·ªán tho·∫°i!");
            return;
        }
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        startTimer();
        renderQuestion();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) showResults();
        }, 1000);
    }

    function renderQuestion() {
        const q = questions[currentIdx];
        selectedIdx = null; 

        document.getElementById('question-counter').innerText = `C√¢u h·ªèi ${currentIdx + 1}/${questions.length}`;
        document.getElementById('question-text').innerText = q.q;
        document.getElementById('progress').style.width = ((currentIdx + 1) / questions.length) * 100 + '%';
        
        const readingPassage = document.getElementById('reading-passage');
        if (currentIdx >= 11 && currentIdx <= 13) {
            readingPassage.style.display = 'block';
            readingPassage.innerHTML = `
                <div style="background: #f0f7ff; border-left: 4px solid #5b8cff; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-top:0; color:#5b8cff;"><i class="fas fa-book-open"></i> ƒê·ªçc ƒëo·∫°n vƒÉn sau:</h4>
                    <p style="font-style: italic; line-height: 1.6; color: #334155; margin: 0;">
                        "My name is Lian. I live in Malaysia. I work in a travel agency. Every day, I help
                        people plan their holidays. I love my job because I learn about new places. In
                        my free time, I watch wildlife shows and listen to pop music."
                    </p>
                </div>
            `;
        } else {
            readingPassage.style.display = 'none';
        }

        const container = document.getElementById('options-container');
        container.innerHTML = '';

        if (q.type === 'writing') {
            const textarea = document.createElement('textarea');
            textarea.id = 'writing-task';
            textarea.placeholder = 'Nh·∫≠p √≠t nh·∫•t 3 c√¢u...';
            textarea.style.cssText = "font-family: 'Roboto', Arial, sans-serif !important;width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; min-height: 120px; box-sizing: border-box;";
            selectedIdx = "writing"; 
            container.appendChild(textarea);
            const voiceHTML = `
            <div class="voice-record-section" style="margin-top: 15px; text-align: center;">
                <p style="font-style: italic; font-size: 0.9em; color: #666;">
                    Sau khi vi·∫øt xong, h√£y b·∫•m ghi √¢m v√† ƒë·ªçc l·∫°i ƒëo·∫°n vƒÉn tr√™n ƒë·ªÉ gi√°o vi√™n s·ª≠a ph√°t √¢m nh√©!
                </p>
                <button type="button" id="startRecord" class="btn-record" style="background: #e74c3c; color: white; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer;">
                    <i class="fas fa-microphone"></i> B·∫Øt ƒë·∫ßu ghi √¢m
                </button>
                <button type="button" id="stopRecord" style="display:none; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer;">
                    <i class="fas fa-stop"></i> D·ª´ng & L∆∞u
                </button>
                <div id="recordStatus" style="margin-top: 10px; font-weight: bold; color: #e74c3c;"></div>
                <audio id="audioPlayback" controls style="display:none; margin: 10px auto;"></audio>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', voiceHTML);
    
        selectedIdx = "writing"; // ƒê√°nh d·∫•u ƒë√£ ch·ªçn (ƒë·ªÉ qua c√¢u ti·∫øp theo)
        } else {
            q.options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerText = opt;
                div.onclick = () => {
                    document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedIdx = idx;
                };
                container.appendChild(div);
            });
        }
    }

    function nextQuestion() {
        if (selectedIdx === null) { alert("Vui l√≤ng ch·ªçn ƒë√°p √°n!"); return; }
        
        const currentQ = questions[currentIdx];
        if (currentQ.type !== 'writing') {
            if (selectedIdx === currentQ.answer) {
                score++;
            } else {
                // S·ª≠a l·ªói: ƒê·∫£m b·∫£o userWrongAnswers ƒë√£ t·ªìn t·∫°i
                userWrongAnswers.push(`${currentQ.q} (Ch·ªçn: ${currentQ.options[selectedIdx]} | ƒê√∫ng: ${currentQ.options[currentQ.answer]})`);
            }
        }

        currentIdx++;
        if (currentIdx < questions.length) {
            renderQuestion();
        } else {
            showResults();
        }
    }

    async function uploadAudioToCloudinary(blob) {
        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dnt6j6wyo/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'ivyenglish_upload'; // v√≠ d·ª•: ivy_upload
        
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        try {
            const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            const data = await response.json();
            return data.secure_url || ""; 
        } catch (error) {
            console.error("L·ªói Cloudinary:", error);
            return "";
        }
    }

    async function showResults() {
        clearInterval(timerInterval);
        document.getElementById('exam-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        
        const scoreElement = document.getElementById('score-number');
        const aiFeedbackElement = document.getElementById('ai-feedback');
        const nameVal = document.getElementById('userName').value;
        const phoneVal = document.getElementById('userPhone').value;
        
        // 1. CH·∫§M ƒêI·ªÇM C√ÇU 15 (WRITING)
        const writingVal = document.getElementById('writing-task') ? document.getElementById('writing-task').value.trim() : "";
        let writingScore = 0;
        if (writingVal.length > 0) {
            writingScore = 1; // C√≥ nh·∫≠p l√† ƒë∆∞·ª£c 1 ƒëi·ªÉm theo y√™u c·∫ßu c·ªßa b·∫°n
        }

        const finalScore = score + writingScore;
        if (scoreElement) scoreElement.innerText = finalScore;

        // 2. PH√ÇN LO·∫†I TR√åNH ƒê·ªò V√Ä NH·∫¨N X√âT T√ôY BI·∫æN
        let level = "", desc = "", customComment = "";

        if (finalScore <= 5) { 
            level = "A1 - BEGINNER"; 
            desc = "B·∫°n ƒëang ·ªü tr√¨nh ƒë·ªô b·∫Øt ƒë·∫ßu. Kh√≥a h·ªçc A1 s·∫Ω gi√∫p b·∫°n x√¢y d·ª±ng n·ªÅn t·∫£ng v·ªØng ch·∫Øc.";
            customComment = "ƒê·ª´ng n·∫£n l√≤ng nh√©! Ti·∫øng Anh l√† m·ªôt h√†nh tr√¨nh. B·∫°n n√™n t·∫≠p trung v√†o t·ª´ v·ª±ng c∆° b·∫£n v√† c√°c c·∫•u tr√∫c c√¢u ƒë∆°n gi·∫£n tr∆∞·ªõc khi ti·∫øn xa h∆°n.";
        } else if (finalScore <= 9) { 
            level = "A2 - ELEMENTARY"; 
            desc = "Kh√° t·ªët! Kh√≥a A2 s·∫Ω gi√∫p b·∫°n giao ti·∫øp t·ª± tin h∆°n trong ƒë·ªùi s·ªëng.";
            customComment = "B·∫°n ƒë√£ c√≥ n·ªÅn t·∫£ng c∆° b·∫£n kh√° ·ªïn. ƒê·ªÉ b·ª©t ph√°, b·∫°n c·∫ßn luy·ªán t·∫≠p ph·∫£n x·∫° giao ti·∫øp v√† m·ªü r·ªông v·ªën t·ª´ v·ª±ng theo ch·ªß ƒë·ªÅ h√†ng ng√†y.";
        } else if (finalScore <= 12) { 
            level = "B1 - INTERMEDIATE"; 
            desc = "R·∫•t t·ªët! B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ti·∫øng Anh linh ho·∫°t trong nhi·ªÅu t√¨nh hu·ªëng.";
            customComment = "Kh·∫£ nƒÉng ƒë·ªçc hi·ªÉu v√† ng·ªØ ph√°p c·ªßa b·∫°n r·∫•t t·ªët! Giai ƒëo·∫°n n√†y b·∫°n n√™n t·∫≠p trung v√†o vi·ªác vi·∫øt c√°c ƒëo·∫°n vƒÉn d√†i h∆°n v√† nghe c√°c b·∫£n tin ti·∫øng Anh t·ªëc ƒë·ªô t·ª± nhi√™n.";
        } else { 
            level = "B2 - UPPER INTERMEDIATE"; 
            desc = "Xu·∫•t s·∫Øc! B·∫°n c√≥ kh·∫£ nƒÉng s·ª≠ d·ª•ng ti·∫øng Anh chuy√™n s√¢u v√† t·ª± nhi√™n.";
            customComment = "Tuy·ªát v·ªùi! B·∫°n c√≥ t∆∞ duy ng√¥n ng·ªØ r·∫•t s·∫Øc b√©n. B·∫°n ho√†n to√†n c√≥ th·ªÉ chinh ph·ª•c c√°c ch·ª©ng ch·ªâ qu·ªëc t·∫ø nh∆∞ IELTS 6.5+ ho·∫∑c l√†m vi·ªác trong m√¥i tr∆∞·ªùng ƒëa qu·ªëc gia.";
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ l√™n m√†n h√¨nh
        document.getElementById('suggested-course').innerText = level;
        document.getElementById('course-desc').innerText = desc;
        if (aiFeedbackElement) {
            aiFeedbackElement.innerHTML = `<strong>L·ªùi khuy√™n t·ª´ gi√°o vi√™n:</strong> ${customComment}`;
        }

        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        let finalAudioLink = "";
        if (window.currentAudioBlob) {
            try {
                document.getElementById('recordStatus').innerText = " ƒëang t·∫£i file ghi √¢m...";
                finalAudioLink = await uploadAudioToCloudinary(window.currentAudioBlob);
                // Quan tr·ªçng: G√°n link v·ª´a upload ƒë∆∞·ª£c v√†o bi·∫øn ƒë·ªÉ g·ª≠i l√™n Sheet
                window.recordedAudioLink = finalAudioLink; 
            } catch (e) {
                console.error("L·ªói upload √¢m thanh:", e);
            }
        }

        // 3. G·ª¨I D·ªÆ LI·ªÜU L√äN SHEETDB (S·ª≠ d·ª•ng mode no-cors ƒë·ªÉ tr√°nh l·ªói ch·∫∑n t·ª´ file local)
        const payload = {
            "ID": Date.now().toString(),
            "ThoiGian": new Date().toLocaleString('vi-VN'),
            "HoTen": nameVal,
            "Sdt": phoneVal,
            "DiemSo": finalScore + "/15",
            "ChiTietCauSai": `Tr·∫Øc nghi·ªám: ${score}/14 - Vi·∫øt: ${writingScore} \nC√¢u sai: ${userWrongAnswers.join("\n ")}`,
            "BaiViet": writingVal,
            "TrinhDo": level,
            "LinkGhiAm": window.recordedAudioLink || ""
        };

        fetch("https://sheetdb.io/api/v1/qvitsb1q8evc9?sheet=QuizResults", {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json' 
            },
            body: JSON.stringify({ 
                data: [
                    {
                        "ID": Date.now().toString(),
                        "ThoiGian": new Date().toLocaleString('vi-VN'),
                        "HoTen": nameVal,
                        "Sdt": phoneVal,
                        "DiemSo": finalScore + "/15",
                        "ChiTietCauSai": `Tr·∫Øc nghi·ªám: ${score}/14 - Vi·∫øt: ${writingScore} \nC√¢u sai: ${userWrongAnswers.join("\n ")}`,
                        "BaiViet": writingVal,
                        "TrinhDo": level,
                        "LinkGhiAm": window.recordedAudioLink || "" // ƒê·∫£m b·∫£o d√πng ƒë√∫ng bi·∫øn n√†y
                    }
                ] 
            })
        })
        .then(res => res.json())
        .then(data => console.log("ƒê√£ l∆∞u v√†o Sheet:", data))
        .catch(err => console.error("L·ªói g·ª≠i SheetDB:", err));
    }

    let mediaRecorder;
    let audioChunks = [];

    // S·ª≠ d·ª•ng Event Delegation v√¨ c√°c n√∫t n√†y ƒë∆∞·ª£c t·∫°o ƒë·ªông khi showQuestion
    document.addEventListener('click', async function(e) {
        if (e.target && e.target.id === 'startRecord') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    window.currentAudioBlob = audioBlob; 
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayback').src = audioUrl;
                    document.getElementById('audioPlayback').style.display = 'block';
                };

                mediaRecorder.start();
                document.getElementById('startRecord').style.display = 'none';
                document.getElementById('stopRecord').style.display = 'inline-block';
                document.getElementById('recordStatus').innerText = "üî¥ ƒêang ghi √¢m... (H√£y ƒë·ªçc ƒëo·∫°n vƒÉn c·ªßa b·∫°n)";
            } catch (err) {
                alert("B·∫°n c·∫ßn cho ph√©p truy c·∫≠p Microphone ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y!");
            }
        }

        if (e.target && e.target.id === 'stopRecord') {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('stopRecord').style.display = 'none';
                document.getElementById('startRecord').style.display = 'inline-block';
                document.getElementById('startRecord').innerHTML = '<i class="fas fa-redo"></i> Ghi √¢m l·∫°i';
                document.getElementById('recordStatus').innerText = "‚úÖ ƒê√£ ghi xong!";
            }
        }
    });
</script>
</body>
</html>